{"version":3,"file":"CorrelationContextManager.js","sourceRoot":"","sources":["../../AutoCollection/CorrelationContextManager.ts"],"names":[],"mappings":"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","sourcesContent":["import http = require(\"http\");\nimport events = require(\"events\");\nimport Util = require(\"../Library/Util\");\nimport Logging = require(\"../Library/Logging\");\n\nimport * as DiagChannel from \"./diagnostic-channel/initialization\";\n\n// Don't reference modules from these directly. Use only for types.\nimport * as cls from \"cls-hooked\";\nimport Traceparent = require(\"../Library/Traceparent\");\nimport Tracestate = require(\"../Library/Tracestate\");\n\nexport interface CustomProperties {\n    /**\n     * Get a custom property from the correlation context\n     */\n    getProperty(key: string): string;\n    /**\n     * Store a custom property in the correlation context.\n     * Do not store sensitive information here.\n     * Properties stored here are exposed via outgoing HTTP headers for correlating data cross-component.\n     * The characters ',' and '=' are disallowed within keys or values.\n     */\n    setProperty(key: string, value: string): void;\n}\n\nexport interface PrivateCustomProperties extends CustomProperties {\n    addHeaderData(header: string): void;\n    serializeToHeader(): string;\n}\n\nexport interface CorrelationContext {\n    operation: {\n        name: string;\n        id: string;\n        parentId: string; // Always used for dependencies, may be ignored in favor of incoming headers for requests\n        traceparent?: Traceparent; // w3c context trace\n        tracestate?: Tracestate; // w3c context state\n    };\n\n    /** Do not store sensitive information here.\n     *  Properties here are exposed via outgoing HTTP headers for correlating data cross-component.\n     */\n    customProperties: CustomProperties\n}\n\nexport class CorrelationContextManager {\n    private static enabled: boolean = false;\n    private static hasEverEnabled: boolean = false;\n    private static forceClsHooked: boolean = undefined; // true: use cls-hooked, false: use cls, undefined: choose based on node version\n    private static session: cls.Namespace;\n    private static cls: typeof cls;\n    private static CONTEXT_NAME = \"ApplicationInsights-Context\"\n\n    /**\n     *  Provides the current Context.\n     *  The context is the most recent one entered into for the current\n     *  logical chain of execution, including across asynchronous calls.\n     */\n    public static getCurrentContext(): CorrelationContext {\n        if (!CorrelationContextManager.enabled) {\n            return null;\n        }\n        const context = CorrelationContextManager.session.get(CorrelationContextManager.CONTEXT_NAME);\n\n        if (context === undefined) { // cast undefined to null\n            return null;\n        }\n        return context;\n    }\n\n    /**\n     *  A helper to generate objects conforming to the CorrelationContext interface\n     */\n    public static generateContextObject(operationId: string, parentId?: string, operationName?: string, correlationContextHeader?: string, traceparent?: Traceparent, tracestate?: Tracestate): CorrelationContext {\n        parentId = parentId || operationId;\n\n        if (this.enabled) {\n            return {\n                operation: {\n                    name: operationName,\n                    id: operationId,\n                    parentId: parentId,\n                    traceparent,\n                    tracestate\n                },\n                customProperties: new CustomPropertiesImpl(correlationContextHeader)\n            };\n        }\n\n        return null;\n    }\n\n    /**\n     *  Runs a function inside a given Context.\n     *  All logical children of the execution path that entered this Context\n     *  will receive this Context object on calls to GetCurrentContext.\n     */\n    public static runWithContext(context: CorrelationContext, fn: ()=>any): any {\n        if (CorrelationContextManager.enabled) {\n            return CorrelationContextManager.session.bind(fn, {[CorrelationContextManager.CONTEXT_NAME]: context})();\n        } else {\n            return fn();\n        }\n    }\n\n    /**\n     * Wrapper for cls-hooked bindEmitter method\n     */\n    public static wrapEmitter(emitter: events.EventEmitter): void {\n        if (CorrelationContextManager.enabled) {\n            CorrelationContextManager.session.bindEmitter(emitter);\n        }\n    }\n\n    /**\n     *  Patches a callback to restore the correct Context when getCurrentContext\n     *  is run within it. This is necessary if automatic correlation fails to work\n     *  with user-included libraries.\n     *\n     *  The supplied callback will be given the same context that was present for\n     *  the call to wrapCallback.  */\n    public static wrapCallback<T extends Function>(fn: T): T {\n        if (CorrelationContextManager.enabled) {\n            return CorrelationContextManager.session.bind(fn);\n        }\n        return fn;\n    }\n\n    /**\n     *  Enables the CorrelationContextManager.\n     */\n    public static enable(forceClsHooked?: boolean) {\n        if (this.enabled) {\n            return;\n        }\n\n        if (!this.isNodeVersionCompatible()) {\n            this.enabled = false;\n            return;\n        }\n        if (!CorrelationContextManager.hasEverEnabled) {\n            this.forceClsHooked = forceClsHooked;\n            this.hasEverEnabled = true;\n\n            if (typeof this.cls === \"undefined\") {\n                if ((CorrelationContextManager.forceClsHooked === true) || (CorrelationContextManager.forceClsHooked === undefined && CorrelationContextManager.shouldUseClsHooked())) {\n                    this.cls = require('cls-hooked');\n                } else {\n                    this.cls = require('continuation-local-storage');\n                }\n            }\n\n            CorrelationContextManager.session = this.cls.createNamespace(\"AI-CLS-Session\");\n\n            DiagChannel.registerContextPreservation((cb) => {\n                return CorrelationContextManager.session.bind(cb);\n            });\n        }\n\n        this.enabled = true;\n    }\n\n    /**\n     *  Disables the CorrelationContextManager.\n     */\n    public static disable() {\n        this.enabled = false;\n    }\n\n    /**\n     * Reset the namespace\n     */\n    public static reset() {\n        if (CorrelationContextManager.hasEverEnabled) {\n            CorrelationContextManager.session = null;\n            CorrelationContextManager.session = this.cls.createNamespace('AI-CLS-Session');\n        }\n    }\n\n    /**\n     *  Reports if CorrelationContextManager is able to run in this environment\n     */\n    public static isNodeVersionCompatible() {\n        var nodeVer = process.versions.node.split(\".\");\n        return parseInt(nodeVer[0]) > 3 || (parseInt(nodeVer[0]) > 2 && parseInt(nodeVer[1]) > 2);\n\n    }\n\n    /**\n     * We only want to use cls-hooked when it uses async_hooks api (8.2+), else\n     * use async-listener (plain -cls)\n     */\n    public static shouldUseClsHooked() {\n        var nodeVer = process.versions.node.split(\".\");\n        return (parseInt(nodeVer[0]) > 8) || (parseInt(nodeVer[0]) >= 8 && parseInt(nodeVer[1]) >= 2);\n    }\n\n    /**\n     * A TypeError is triggered by cls-hooked for node [8.0, 8.2)\n     * @internal Used in tests only\n     */\n    public static canUseClsHooked() {\n        var nodeVer = process.versions.node.split(\".\");\n        var greater800 = (parseInt(nodeVer[0]) > 8) || (parseInt(nodeVer[0]) >= 8 && parseInt(nodeVer[1]) >= 0);\n        var less820 = (parseInt(nodeVer[0]) < 8) || (parseInt(nodeVer[0]) <= 8 && parseInt(nodeVer[1]) < 2)\n        var greater470 = parseInt(nodeVer[0]) > 4 || (parseInt(nodeVer[0]) >= 4 && parseInt(nodeVer[1]) >= 7) // cls-hooked requires node 4.7+\n        return !(greater800 && less820) && greater470;\n    }\n}\n\nclass CustomPropertiesImpl implements PrivateCustomProperties {\n    private static bannedCharacters = /[,=]/;\n    private props: {key: string, value:string}[] = [];\n\n    public constructor(header: string) {\n        this.addHeaderData(header);\n    }\n\n    public addHeaderData(header?: string) {\n        const keyvals = header ? header.split(\", \") : [];\n        this.props = keyvals.map((keyval) => {\n            const parts = keyval.split(\"=\");\n            return {key: parts[0], value: parts[1]};\n        }).concat(this.props);\n    }\n\n    public serializeToHeader() {\n        return this.props.map((keyval) => {\n            return `${keyval.key}=${keyval.value}`\n        }).join(\", \");\n    }\n\n    public getProperty(prop: string) {\n        for(let i = 0; i < this.props.length; ++i) {\n            const keyval = this.props[i]\n            if (keyval.key === prop) {\n                return keyval.value;\n            }\n        }\n        return;\n    }\n\n    // TODO: Strictly according to the spec, properties which are recieved from\n    // an incoming request should be left untouched, while we may add our own new\n    // properties. The logic here will need to change to track that.\n    public setProperty(prop: string, val: string) {\n        if (CustomPropertiesImpl.bannedCharacters.test(prop) || CustomPropertiesImpl.bannedCharacters.test(val)) {\n            Logging.warn(\"Correlation context property keys and values must not contain ',' or '='. setProperty was called with key: \" + prop + \" and value: \"+ val);\n            return;\n        }\n        for (let i = 0; i < this.props.length; ++i) {\n            const keyval = this.props[i];\n            if (keyval.key === prop) {\n                keyval.value = val;\n                return;\n            }\n        }\n        this.props.push({key: prop, value: val});\n    }\n}\n"]}